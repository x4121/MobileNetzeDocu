\section{Aufgabenstellung}
\label{sec:aufgabe}

Im Rahmen der Blockveranstaltung ``Mobile Netze'' im Sommersemester 2015 bei Herrn Wischhof sollte eine praktische Anwendung bezüglich GSM-, UMTS- oder WLAN-Netzen auf echter Hardware umgesetzt werden. Die von uns gewählte Aufgabe war das Einrichten eines fakultätseigenen Mobilfunknetz mit GSM.
Zur Verfügung stand uns dafür als \SDR ein \USRP von \emph{Ettus Research}\footnote{\url{http://www.ettus.com/content/files/07495_Ettus_N200-210_DS_Flyer_HR_1.pdf}} auf welchem wir mit \OpenBTS ein \GSM-Netz aufsetzten.

\section{OpenBTS}
\label{sec:openbts}

\OpenBTS\footnote{\url{http://openbts.org}} ist ein open source Softwareprojekt mit dem sich auf einem \SDR, wie dem von uns verwendeten \USRP 2, \GSM- oder auch \UMTS-Netze betreiben lassen.

\subsection{Installation}
\label{sec:installation}

Zur Installation und initialen Einrichtung von \OpenBTS haben wir uns weitestgehend an die Anleitung des \OpenBTS-Git-Repository\footnote{\url{https://github.com/RangeNetworks/dev/wiki}} gehalten.\\Da die Ubuntu-Version auf den Laborrechnern bereits sehr stark veraltet war und durch fehlerhafte Konfigurationen nicht mehr sehr stabil lief, mussten wir diesen zunächst neu aufsetzen. Anschließend haben wir Git installiert und das Git-Repository mit allen
Abhängigkeiten auf den Laborrechner geklont, den aktuellen Branch ausgewählt und für unsere \USRP kompiliert.\\Während dem Kompilieren fiel auf, dass anscheinend nicht alle benötigten Treiber mit dem Repository geladen und installiert werden. Dies ließ sich aber auch durch eine kurze Google-Suche beheben\footnote{\url{http://code.ettus.com/redmine/ettus/projects/uhd/wiki/UHD_Linux}}.

\begin{lstlisting}[language=bash]
sudo apt-get install git
git clone http://github.com/RangeNetworks/dev
cd dev
./clone.sh
./switchto.sh master
sudo bash -c 'echo "deb \
http://files.ettus.com/binaries/uhd/
repo/uhd/ubuntu/`lsb_release \
-cs` `lsb_release -cs` main" >
/etc/apt/sources.list.d/ettus.list'
sudo apt-get update
sudo apt-get install -t `lsb_release -cs` uhd
./build.sh N210
\end{lstlisting}

Nachdem die einzelnen Komponenten kompiliert wurden, konnte man diese und die dazu benötigten Abhängigkeiten auf dem Laborrechner installieren.

\begin{lstlisting}
cd BUILD/*
sudo dpkg -i *.deb
sudo apt-get -f install
\end{lstlisting}

Abschließend musste man nur noch die einzelnen Komponenten starten. Da die Komponenten in Upstart eingetragen wurden, konnte man auch einfach den Laborrechner neustarten.

\subsection{Konfiguration}
\label{sec:konfiguration}
Vor der Inbetriebnahme der Basisstation musste diese auf die gewünschten Bedürfnisse eingestellt werden. Insbesondere betraf das die Konfiguration von OpenBTS und Asterisk. Die Software OpenBTS lässt sich generell über die Datei ``openBts.conf'' konfigurieren. Hierin sind alle Einstellungen für die Basisstation zu sehen. Asterisk kann durch die Datei ```sip.conf'' eingestellt werden. Diese Datei ermöglicht es ein wenig Geschäftslogik umzusetzen, indem bestimmten Rufnummernmustern eine verschiedene Verarbeitung zugeordnet wird. \\

\subsubsection{Konfiguration von OpenBTS}
Als erstes sollte das Frequenzband eingestellt werden, um nicht unbeabsichtigt auf bereits reservierten Bändern zu kommunizieren.  Der für die Hochschule gültige Frequenzbereich kann aus dem entsprechendem Lizenzdokument entnommen werden. Mit Hilfe des Feldes \inlinecode{GSM.Radio.Band} kann das Band eingestellt werden. Die genau Frequenz wird durch die Kanalnummer (ARFCN) durch \inlinecode{GSM.Radio.C0} festgelegt. Die Kanalnummer kann durch die Frequenz folgendermaßen zurück gerechnet werden:\\
$ C0 = \frac{Uplinkfrequenz - Basisfrequenz}{0.2} + Basiskanalnummer $ \\
In unserem Fall war die Lizenz auf dem Uplink mit der Frequenz \SI{1781.2}{\mega\hertz} festgelegt. Dadurch befinden wir uns im Band 1800 mit der Basisfrequenz von 1710.2. Die Basiskanalnummer beträgt in diesem Band 512, wodurch sich für uns folgende Kanalnummer ergab:\\
$ C0 = \frac{?? - 1710.2}{0.2} + 512 = ?? $ \\
Danach wurden die MCC, MNC sowie der Name der Basisstation konfiguriert. Der MCC (Mobile Country Code) gibt an, in welchem Land die Basistation betrieben wird. Der MNC (Mobile Network Code) spiegelt wiederum den Betreiber wider. Der MCC für Deutschland lautet 262. Diese Codes können entsprechend durch die Felder \inlinecode{GSM.Identity.MCC} und \inlinecode{GSM.Identity.MNC} angegeben werden. Der Name der Basisstation wird durch das Feld \inlinecode{GSM.Identity.ShortName} definiert und bei der Suche nach einem Netzwerk beim Endgerät angezeigt. \\
Die Basisstation sollte so eingestellt werden, dass sie nur vordefinierte \acp{IMSI} akzeptiert und nur zu diesen eine Verbindung aufbaut. Ansonsten verbinden sich alle in der Nähe befindlichen Endgeräte mit dieser Basisstation, falls sie die einzige verfügbare in der Nähe ist. Um nur ausgewählte \acp{IMSI} zu zulassen kann ein regulärer Ausdruck in das Feld \inlinecode{Control.LUR.OpenRegistration} eingetragen werden. Dieser Ausdruck sah in unserem Fall folgendermaßen aus: \\ \inlinecode{(262017540093841)|(262014520187752)|(262017241084828)|(262073920210702)|(262016144053673)} \\
Möchte man diese Basisstation professionell betreiben, sollte eine eigene MNC verwendet werden. Dazu müssten man jedoch eigene \SIM-Karten herstellen (wie zum Beispiel das CCC mit einer MNC von 42). Dadurch kann der reguläre Ausdruck einfach auf die MNC hin eingestellt werden, wodurch sie nicht bei jeder neuen \IMSI geändert werden muss.


\subsubsection{Konfiguration von Asterisk}
Asterisk ist für die Verarbeitung von eingehenden Daten (wie Anrufen, SMS, usw.) verantwortlich. Es vergibt auch Rufnummern an die bestimmten Netzwerkteilnehmer. Asterisk liefert eine SQLite-Datenbank mit, welche diese Daten beinhaltet. Zu Testzwecken wurde diese Datenbank zunächst manuell durch ein Skript befüllt. Dieses Skript ist in Anhang ?? zu finden. Für jede \IMSI wird ein Eintrag in die Tabelle ``sip\_buddies'' getätigt, wodurch diese \IMSI im System als registriert gilt. Außerdem wird in die Tabelle ``dialdata\_table'' noch für jede registrierte IMSI eine Rufnummer vergeben, unter welcher diese dann im Netzwerk ansprechbar ist. Später wurde diese Aufgabe durch unsere Applikation übernommen. Die Datenbank ist unter \textit{/var/lib/asterisk/sqlite3dir/sqlite3.db} zu finden.

\textbf{Hier Erklärung der sip.conf}

\subsection{Inbetriebnahme}
\label{sec:inbetriebnahme}
Nach erfolgreichem Starten der Dienste von OpenBTS und Asterisk konnten erste Tests durchgeführt werden. Dafür ist die Asterisk-CLI eine gute Möglichkeit. Diese kann durch den Befehl \inlinecode{sudo asterisk -rvvv} gestartet werden. Sie bietet beispielsweise ein Kommando zum versenden von SMS an Netzwerkteilnehmer, welche wie folgt aussieht:\\
\inlinecode{sendsms IMSI Nachricht}\\
und kann beispielsweise folgendermaßen aussehen:\\
\inlinecode{sendsms 262017540093841 Hallo, das ist eine Test-SMS!}\\
Eine erfolgreich empfangene \SMS weist darauf hin, dass die \IMSI erfolgreich im Netzwerk registriert worden ist. Jetzt können weitere Tests in Verbindung mit Asterisk begonnen werden. Zunächst wurde überprüft, ob die Nummer 222, welche eine ``Hello World''-Wiedergabe liefert, erreichbar ist. Bei Erfolg wird am Endgerät eine entsprechende Meldung wiedergegeben. Letztendlich wurde versucht ein Telefonat zwischen zwei Endgeräten aufbauen zu können. Dafür ist in einem Endgerät die Rufnummer eines anderen im Netzwerk registrierten Endgerät angerufen worden. Nach richtiger Konfiguration konnten beide Teilnehmer über unsere Basisstation miteinander über ein Telefonat kommunizieren. \\
Das \CLI dient außerdem wie eine Art Logger. Sie liefert Konsolenausgaben bei allen Aktivitäten im Netzwerk und lässt durch Meldungen auf potentielle Fehler hinweisen. 

\subsection{Herausforderungen}
\label{sec:herausforderung}
Nachdem die Konfiguration nach \autoref{sec:konfiguration} erfolgte, konnten sich Mobilteile im eigenen Netz registrieren und wurden durch die erstellte Willkommensnachricht begrüßt (siehe \autoref{fig:welcomeMessage}\todo{hat wer eine SMS mit der neuen Nachricht?}).

\begin{figure}[h!]
	\centering
	\includegraphics[width=.8\textwidth]{\picdir welcome_message.png}
	\caption{Willkommensnachricht im Labornetz}
	\label{fig:welcomeMessage}
	
\end{figure}
Über das \OpenBTS-\CLI konnten die angemeldeten Teilnehmer mithilfe des Befehls \inlinecode{tmsis} anhand ihrer \IMSI identifiziert werden. Mit dem Befehl \inlinecode{sendsms <IMSI> <sourceAddress> <message text>} kann an die \emph{\IMSI} eine \SMS-Nachricht (\emph{message text}) mit dem Absender \emph{sourceAddress} versandt werden.

Hierbei ließen sich bereits Inkonsistenzen in der Auslieferung der erstellten \SMS feststellen. Nach der erfolgreichen Integration von \OpenBTS mit Asterisk verblieb sowohl die Auslieferungsrate von \SMS-Nachrichten auf die hinterlegte Rufnummer auf einem niedrigen Niveau unter zehn Prozent als auch das erfolgreiche Pagen der Mobilteile.
\subsubsection{Konsistenter Verbindungsaufbau}
Nach tagelangem Konfigurieren ließ sich zwar keine Verbesserung in der Zustellrate von \SMS-Nachrichten und einem konsistenten Rufaufbau erzielen, dennoch führten die getätigten Beobachtungen letztendlich zur Fehlerfindung. War das zu pagende Gerät weiter entfernt als unser normaler Laborarbeitsplatz, so stieg die Zustellrate signifikant an.
Die Ursache hierfür lag demnach in der zu hohen Sendeleistung der Basisstation.

Durch ein Absenken der voreingestellten minimalen (\emph{GSM.MS.Power.Min}) und maximalen (\emph{GSM.MS.Power.Max}) Leistungsgrenzen in der Konfiguration von \SI{5}{dBm} beziehungsweise \SI{33}{dBm} auf \SI{0}{dBm} respektive \SI{1}{dBm} verbesserte sich der Verbindungsaufbau nochmals. 
Die im Labor beste Verbindungsrate konnte durch das zusätzliche Anbringen eines Dämpfungsglieds von \SI{10}{dB} an der Transmit-Antenne und der vorhin genannten Leistungsgrenzen erzielt werden. 
In \autoref{fig:attenuator} ist das montierte Dämpfungsglied an der Antennenbuchse \emph{RF~1} zu erkennen.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\textwidth]{\picdir IMG_20150313_142115.jpg}
	\caption{Angebrachtes Dämpfungsglied am \acs*{USRP}}
	\label{fig:attenuator}
\end{figure}


\subsubsection{Automatisierte Benutzeranmeldung}
Wie in \autoref{sec:konfiguration} beschrieben, wurden die Teilnehmer mit deren \IMSI und gewünschter Telefonnummer in die Asterisk-Datenbank von Hand eingetragen. Selbst im Laborversuch mit einer geringen Geräteanzahl stellte sich dies als zu unkomfortabel heraus.
Aus diesem Grund wurde die bestehende Funktionalität von \OpenBTS und Asterisk über die Konfiguration entsprechend der Vorstellung der Gruppenmitgliedern angepasst.

Die Willkommensnachricht weist die neuen Benutzer an, mit einer gewünschten Telefonnummer per \SMS-Nachricht zu antworten, damit ihnen diese zugeteilt werden kann. Wird eine bereits verwendete oder ungültige Rufnummer angegeben, so wird dies dem Benutzer wiederum per \SMS-Nachricht mitgeteilt.
Erfolgt die Rufnummernbindung an die \IMSI, so wird diese Zuordnung in der Asterisk-Datenbank in \emph{/var/lib/asterisk/sqlite3dir/sqlite3.db} persistiert.

\subsubsection{Aktualisierung der registrierten Benutzer}
Die zu erstellende Anwendung (siehe Kapitel \nameref{sec:frontend} und \nameref{sec:backend}) fordert eine Aktualisierung der aktiv angemeldeten Benutzer. Dies stellt eine vereinfachte Form eines Präsenzdienstes darstellt.\\
Die bestehende Konfiguration aus \autoref{sec:konfiguration} widerspricht mit den voreingestellten Standardwerten klar dieser Forderung. 
Im Labor wurden inaktive Geräte nicht auf Existenz überprüft, d.~h. solange ein \UE nicht selbständig aktiv eine Verbindung aufbaute, wurde die zugehörige \IMSI in der Ausgabe des \inlinecode{tmsis}-Befehls nicht aktualisiert. Um diese Malaise zu mindern, werden die folgenden Parameter angepasst.\\
Mit einem Konfigurationswert \inlinecode{1} für \inlinecode{Control.LUR.QueryIMEI} wird von jeder Mobilstation bei einem initialen \LUR die \IMEI abgefragt.\\
Durch das Setzen von \inlinecode{Control.LUR.SendTMSIs} auf \inlinecode{1} werden neue \TMSI-Zuweisungen an die Mobilgeräte gesendet, die sich im Netzwerk anmelden dürfen (siehe \autoref{sec:konfiguration} \inlinecode{Control.LUR.OpenRegistration}). Diese Änderungen werden in die \TMSI-Datenbank gespeichert, die über das Konfigurationselement \inlinecode{Control.Reporting.\allowbreak TMSITable} eingestellt werden kann, und können somit direkt aus der Datenbank ausgelesen werden oder über die Ausgabe des Befehls \inlinecode{tmsis}.\\
Des Weiteren muss der Zeitschritt für die Registrierungsgültigkeit in Minuten \inlinecode{GSM.Timer.T3212} konfiguriert werden, der auf ein vielfaches von sechs und mindestens dieselbe Zahl gestellt werden kann. Da die Konfigurationsoption \inlinecode{SIP.RegistrationPeriod}, die eine Registrierungszeitspanne in Minuten angibt, echt größer dem \inlinecode{GSM.Timer.T3212}-Wert sein muss, wird diese auf 7 [Minuten] und der letztgenannte auf 6 [Minuten] festgelegt.\\
Mit dieser veränderten Konfiguration werden inaktive Mobilgeräte nach spätestens sieben Minuten als \emph{außer Reichweite} oder \emph{im Stand-by} erkannt, womit der Präsenzdienst seine Funktion mit einer zeitlichen Untergrenze von eben erwähnten sieben Minuten erfüllen kann.
